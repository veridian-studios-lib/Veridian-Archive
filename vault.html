<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veridian | The Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Fauna+One&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --bg: #0F0A05; --card: #1A140E; }
        body { font-family: 'Fauna One', serif; background-color: var(--bg); color: var(--gold); padding: 40px 20px; }
        .lux-serif { font-family: 'Cinzel', serif; letter-spacing: 0.15em; }
        
        /* Category Header */
        .category-header { 
            border-bottom: 1px solid rgba(212, 175, 55, 0.3); 
            margin: 50px 0 20px 0; padding-bottom: 10px;
            font-size: 0.9rem; color: var(--gold); 
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }

        /* The Grid */
        .book-row {
            display: grid; 
            grid-template-columns: 2fr 1.5fr 80px 100px; /* Adjusted col sizes */
            align-items: center; gap: 15px;
            padding: 18px 15px; border-bottom: 1px solid rgba(212, 175, 55, 0.05);
            transition: 0.2s; background: var(--card); border-radius: 4px; margin-bottom: 8px;
        }
        .book-row:hover { 
            background: rgba(212, 175, 55, 0.08); 
            border-color: rgba(212, 175, 55, 0.3);
            transform: translateX(4px);
        }

        /* Text Safety (Prevents layout breaking) */
        .truncate-text {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .book-title { font-weight: bold; font-size: 0.9rem; letter-spacing: 0.05em; color: #fff; }
        .book-author { opacity: 0.6; font-size: 0.75rem; font-style: italic; color: var(--gold); }
        
        /* Buttons */
        .read-link { 
            display: block; text-align: center; color: var(--gold); text-decoration: none; 
            border: 1px solid rgba(212, 175, 55, 0.3); padding: 6px 0; 
            font-size: 0.65rem; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .read-link:hover { background: var(--gold); color: black; font-weight: bold; }

        .delete-btn {
            text-align: center; color: #ff5555; cursor: pointer; opacity: 0.5;
            font-size: 0.65rem; transition: 0.3s; letter-spacing: 0.1em; text-transform: uppercase;
        }
        .delete-btn:hover { opacity: 1; text-decoration: underline; text-shadow: 0 0 8px rgba(255, 85, 85, 0.5); }
    </style>
</head>
<body class="max-w-5xl mx-auto">

    <header class="mb-16 text-center">
        <button onclick="window.location.href='dashboard.html'" class="text-[10px] uppercase tracking-widest opacity-30 hover:opacity-100 transition-all mb-4">‚Üê Return to Dashboard</button>
        <h1 class="lux-serif text-4xl">THE ARCHIVE</h1>
        <div class="h-[1px] w-24 bg-[#D4AF37] mx-auto my-6 opacity-30"></div>
        <p id="total-books" class="text-[10px] uppercase tracking-[0.3em] opacity-50">Loading Archive...</p>
    </header>

    <div id="archive-container">
        </div>

    <script>
        // The 8 Pillars (Master List)
        const CATEGORIES = [
            "Philosophy", "History", "Science", "Fiction", 
            "Poetry", "Biography", "Religion", "Other Wisdom"
        ];

        async function renderVault() {
            const container = document.getElementById('archive-container');
            
            // 1. Fetch Library
            let library = [];
            try {
                library = await localforage.getItem('veridian_1_library') || [];
            } catch (e) { console.error("Database Error:", e); }

            // 2. Update Stats
            document.getElementById('total-books').innerText = library.length + " VOLUMES STORED";
            container.innerHTML = '';

            if (library.length === 0) {
                container.innerHTML = `<div class="text-center opacity-30 mt-20 italic">The Archive is empty. Go forth and discover wisdom.</div>`;
                return;
            }

            // 3. Sort & Render Categories
            CATEGORIES.forEach(cat => {
                // Filter books for this category
                const booksInCat = library.filter(book => {
                    // Safe logic: Handle missing categories and Case Sensitivity
                    const bookCat = (book.category || "Other Wisdom").trim();
                    const targetCat = cat;

                    // Standard Comparison (Science == Science)
                    if (bookCat.toLowerCase() === targetCat.toLowerCase()) return true;

                    // "Other Wisdom" Catch-all Logic
                    if (targetCat === "Other Wisdom") {
                        // If book category is NOT found in the main list, it goes here
                        const knownCategories = CATEGORIES.map(c => c.toLowerCase());
                        return !knownCategories.includes(bookCat.toLowerCase());
                    }
                    return false;
                });

                // Only render section if books exist
                if (booksInCat.length > 0) {
                    const section = document.createElement('div');
                    section.innerHTML = `<h2 class="category-header lux-serif uppercase">${cat}</h2>`;
                    
                    booksInCat.forEach(book => {
                        // FALLBACK: If book has no ID (old data), use Title or Random
                        const safeId = book.id || "legacy-" + Math.random().toString(36).substr(2, 9);
                        
                        const row = document.createElement('div');
                        row.className = 'book-row';
                        row.innerHTML = `
                            <div class="book-title truncate-text" title="${book.title}">${book.title}</div>
                            <div class="book-author truncate-text">${book.author || 'Unknown Scribe'}</div>
                            <a href="reader.html?id=${safeId}" class="read-link">READ</a>
                            <div class="delete-btn" onclick="obliterate('${safeId}')">OBLITERATE</div>
                        `;
                        section.appendChild(row);
                    });

                    container.appendChild(section);
                }
            });
        }

        async function obliterate(id) {
            if(confirm("Are you sure you wish to remove this volume from the archive?")) {
                let library = await localforage.getItem('veridian_1_library') || [];
                
                // Remove book by ID
                const newLibrary = library.filter(book => book.id !== id);
                
                // Safety: If ID logic failed (legacy books), try removing by Title as backup
                if (newLibrary.length === library.length) {
                     // (Optional: Advanced logic could go here, but ID usually works)
                }

                await localforage.setItem('veridian_1_library', newLibrary);
                renderVault(); // Refresh
            }
        }

        window.onload = renderVault;
    </script>
</body>
</html>
