<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veridian | The Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Fauna+One&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --bg: #0F0A05; --card: #1A140E; }
        body { font-family: 'Fauna One', serif; background-color: var(--bg); color: var(--gold); padding: 40px 20px; }
        .lux-serif { font-family: 'Cinzel', serif; letter-spacing: 0.15em; }
        
        /* Category Header */
        .category-header { 
            border-bottom: 1px solid rgba(212, 175, 55, 0.3); 
            margin: 60px 0 25px 0; padding-bottom: 10px;
            font-size: 1rem; color: var(--gold); 
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            letter-spacing: 0.2em;
        }

        /* The Grid - Now flexible height */
        .book-row {
            display: grid; 
            /* Columns: Title gets the most space, then Author, then buttons fixed width */
            grid-template-columns: 2fr 1.5fr 80px 100px; 
            align-items: center; gap: 20px;
            padding: 20px 25px; 
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            background: var(--card); 
            border-radius: 6px; 
            margin-bottom: 12px;
            transition: 0.3s ease-in-out;
        }

        .book-row:hover { 
            background: #251d16; 
            border-color: rgba(212, 175, 55, 0.4);
            transform: translateX(5px);
            box-shadow: -5px 5px 20px rgba(0,0,0,0.5);
        }

        /* Title & Author Styling - NO TRUNCATION */
        .book-title { 
            font-weight: bold; font-size: 1rem; 
            color: #fff; line-height: 1.4;
            /* Allow text to wrap naturally */
            word-wrap: break-word; 
        }

        .book-author { 
            font-size: 0.85rem; font-style: italic; 
            color: rgba(212, 175, 55, 0.7);
            line-height: 1.4;
        }
        
        /* Buttons */
        .read-link { 
            display: inline-block; text-align: center; color: var(--gold); text-decoration: none; 
            border: 1px solid rgba(212, 175, 55, 0.3); padding: 8px 0; 
            font-size: 0.7rem; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
            border-radius: 2px;
        }
        .read-link:hover { background: var(--gold); color: black; font-weight: bold; }

        .delete-btn {
            text-align: center; color: #ff5555; cursor: pointer; opacity: 0.5;
            font-size: 0.7rem; transition: 0.3s; letter-spacing: 0.1em; text-transform: uppercase;
        }
        .delete-btn:hover { opacity: 1; text-decoration: underline; text-shadow: 0 0 10px rgba(255, 85, 85, 0.4); }
    </style>
</head>
<body class="max-w-6xl mx-auto">

    <header class="mb-20 text-center pt-10">
        <button onclick="window.location.href='dashboard.html'" class="text-[10px] uppercase tracking-widest opacity-40 hover:opacity-100 transition-all mb-6">‚Üê Return to Dashboard</button>
        <h1 class="lux-serif text-5xl">THE ARCHIVE</h1>
        <div class="h-[1px] w-32 bg-[#D4AF37] mx-auto my-8 opacity-30"></div>
        <p id="total-books" class="text-[10px] uppercase tracking-[0.3em] opacity-60">Scanning Vault...</p>
    </header>

    <div id="archive-container">
        </div>

    <script>
        // The 8 Pillars
        const CATEGORIES = [
            "Philosophy", "History", "Science", "Fiction", 
            "Poetry", "Biography", "Religion", "Other Wisdom"
        ];

        async function renderVault() {
            const container = document.getElementById('archive-container');
            
            // 1. Fetch Library - Ensure we look in the correct 'veridian_1_library' box
            let library = [];
            try {
                library = await localforage.getItem('veridian_1_library') || [];
            } catch (e) { console.error("Database Error:", e); }

            document.getElementById('total-books').innerText = library.length + " VOLUMES STORED";
            container.innerHTML = '';

            if (library.length === 0) {
                container.innerHTML = `<div class="text-center opacity-30 mt-20 italic">The Archive is empty. Upload a book or visit the Great Library.</div>`;
                return;
            }

            // 2. Render Categories
            CATEGORIES.forEach(cat => {
                const booksInCat = library.filter(book => {
                    // Normalize for comparison (handle 'science' vs 'Science')
                    const bookCat = (book.category || "Other Wisdom").trim();
                    
                    if (cat === "Other Wisdom") {
                        // Check if book category is NOT in our main list (case insensitive)
                        const known = CATEGORIES.map(c => c.toLowerCase());
                        return !known.includes(bookCat.toLowerCase());
                    }
                    
                    return bookCat.toLowerCase() === cat.toLowerCase();
                });

                if (booksInCat.length > 0) {
                    const section = document.createElement('div');
                    section.innerHTML = `<h2 class="category-header lux-serif uppercase">${cat}</h2>`;
                    
                    booksInCat.forEach(book => {
                        // Use ID if exists, otherwise fallback to safe random string
                        const safeId = book.id || "legacy-" + Math.random().toString(36).substr(2, 9);
                        
                        const row = document.createElement('div');
                        row.className = 'book-row';
                        row.innerHTML = `
                            <div class="book-title">${book.title}</div>
                            <div class="book-author">${book.author || 'Unknown'}</div>
                            <a href="reader.html?id=${safeId}" class="read-link">READ</a>
                            <div class="delete-btn" onclick="obliterate('${safeId}')">OBLITERATE</div>
                        `;
                        section.appendChild(row);
                    });
                    container.appendChild(section);
                }
            });
        }

        async function obliterate(id) {
            if(confirm("Are you sure you wish to burn this volume? It cannot be undone.")) {
                let library = await localforage.getItem('veridian_1_library') || [];
                
                // Remove the book
                const newLibrary = library.filter(book => book.id !== id);
                
                await localforage.setItem('veridian_1_library', newLibrary);
                renderVault(); // Refresh
            }
        }

        window.onload = renderVault;
    </script>
</body>
</html>
